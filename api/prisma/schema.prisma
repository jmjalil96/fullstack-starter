// Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH MODELS (BetterAuth)
// ============================================================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  name          String?
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // BetterAuth relations
  sessions Session[]
  accounts Account[]

  // Business logic additions
  globalRoleId String?
  globalRole   Role?   @relation(fields: [globalRoleId], references: [id])

  clientAccess UserClient[]

  // Activity relations
  createdClaims    Claim[]          @relation("ClaimCreator")
  updatedClaims    Claim[]          @relation("ClaimUpdater")
  claimInvoices    ClaimInvoice[]
  claimReprocesses ClaimReprocess[]
  createdTickets   Ticket[]         @relation("TicketCreator")
  reportedTickets  Ticket[]        @relation("TicketReporter")
  assignedTickets  Ticket[]        @relation("TicketAssignee")
  ticketMessages   TicketMessage[]
  notifications    Notification[]
  auditLogs        AuditLog[]

  // File storage relations
  uploadedFiles  File[]
  documentGrants DocumentAccess[]

  // Optional: Link to business entities
  employee  Employee?
  agent     Agent?
  affiliate Affiliate?

  // Invitations created by this user
  createdInvitations Invitation[] @relation("InvitationCreator")

  @@index([globalRoleId])
}

model Account {
  id           String   @id @default(uuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  password     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
}

// ============================================================================
// RBAC (Role-Based Access Control)
// ============================================================================

model Role {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  invitations Invitation[]

  @@index([name])
  @@index([isActive])
}

model UserClient {
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, clientId])
  @@index([userId])
  @@index([clientId])
  @@index([isActive])
}

// ============================================================================
// CORE BUSINESS ENTITIES
// ============================================================================

model Client {
  id      String  @id @default(cuid())
  name    String
  taxId   String  @unique
  email   String?
  phone   String?
  address String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userAccess     UserClient[]
  policies       Policy[]
  affiliates     Affiliate[]
  claims         Claim[]
  invoices       Invoice[]
  tickets        Ticket[]
  auditLogs      AuditLog[]

  // File storage relations
  files          File[]
  documentAccess DocumentAccess[]

  @@index([name])
  @@index([isActive])
}

model Insurer {
  id      String  @id @default(cuid())
  name    String  @unique
  code    String? @unique
  email   String?
  phone   String?
  website String?

  billingCutoffDay Int @default(25)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  policies Policy[]
  invoices Invoice[]

  @@index([name])
  @@index([code])
  @@index([isActive])
}

model Policy {
  id           String @id @default(cuid())
  policyNumber String @unique

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  insurerId String
  insurer   Insurer @relation(fields: [insurerId], references: [id])

  type   String?
  status PolicyStatus @default(ACTIVE)

  startDate DateTime
  endDate   DateTime

  // Coverage & Copays
  ambCopay  Float?
  hospCopay Float?
  maternity Float?

  // Premium tiers
  tPremium      Float?
  tplus1Premium Float?
  tplusfPremium Float?

  // Costs
  taxRate         Float?
  additionalCosts Float?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  affiliates      PolicyAffiliate[]
  claims          Claim[]
  invoicePolicies InvoicePolicy[]

  @@index([policyNumber])
  @@index([clientId])
  @@index([insurerId])
  @@index([status])
  @@index([startDate, endDate])
}

model Affiliate {
  id String @id @default(cuid())

  firstName   String
  lastName    String
  email       String?
  phone       String?
  dateOfBirth DateTime?

  documentType   String?
  documentNumber String?

  affiliateType AffiliateType @default(OWNER)
  coverageType  CoverageType?

  // Tier change tracking for T+1 billing adjustments
  tierChangedAt        DateTime?     // When coverage tier was last changed
  previousCoverageType CoverageType? // Tier before the change (for pro-rata calculation)

  primaryAffiliateId String?
  primaryAffiliate   Affiliate?  @relation("AffiliateDependents", fields: [primaryAffiliateId], references: [id], onDelete: SetNull)
  dependents         Affiliate[] @relation("AffiliateDependents")

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  policies          PolicyAffiliate[]
  claimsAsAffiliate Claim[]           @relation("ClaimAffiliate")
  claimsAsPatient   Claim[]           @relation("ClaimPatient")
  invitation        Invitation?

  @@index([clientId])
  @@index([userId])
  @@index([primaryAffiliateId])
  @@index([documentNumber])
  @@index([lastName, firstName])
  @@index([isActive])
  @@index([affiliateType])
}

model PolicyAffiliate {
  policyId String
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  addedAt   DateTime  @default(now())
  removedAt DateTime?
  isActive  Boolean   @default(true)

  @@id([policyId, affiliateId])
  @@index([policyId])
  @@index([affiliateId])
  @@index([isActive])
  @@index([policyId, addedAt])    // For base affiliate date range queries
  @@index([policyId, removedAt]) // For window affiliate date range queries
}

model Employee {
  id String @id @default(cuid())

  firstName String
  lastName  String
  email     String
  phone     String?

  position     String?
  department   String?
  employeeCode String? @unique

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([employeeCode])
  @@index([lastName, firstName])
  @@index([isActive])
  @@index([department])
}

model Agent {
  id String @id @default(cuid())

  firstName String
  lastName  String
  email     String
  phone     String?

  agentCode String? @unique

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([agentCode])
  @@index([lastName, firstName])
  @@index([isActive])
}

model Claim {
  id            String @id @default(cuid())
  claimSequence Int    @unique @default(autoincrement())
  claimNumber   String @unique

  policyId String?
  policy   Policy? @relation(fields: [policyId], references: [id])

  affiliateId String
  affiliate   Affiliate @relation("ClaimAffiliate", fields: [affiliateId], references: [id])

  patientId String
  patient   Affiliate @relation("ClaimPatient", fields: [patientId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  status      ClaimStatus @default(DRAFT)
  description String?

  // Diagnosis information
  careType             CareType?
  diagnosisCode        String?
  diagnosisDescription String?

  // Financial fields
  amountSubmitted   Float?
  amountApproved    Float?
  amountDenied      Float?
  amountUnprocessed Float?
  deductibleApplied Float?
  copayApplied      Float?

  // Date fields
  incidentDate   DateTime? @db.Date
  submittedDate  DateTime? @db.Date
  settlementDate DateTime? @db.Date

  // Settlement fields
  businessDays     Int?
  settlementNumber String?
  settlementNotes  String?

  createdById String
  createdBy   User   @relation("ClaimCreator", fields: [createdById], references: [id])

  updatedById String?
  updatedBy   User?  @relation("ClaimUpdater", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  files       ClaimFile[]
  tickets     Ticket[]
  invoices    ClaimInvoice[]
  reprocesses ClaimReprocess[]

  @@index([claimNumber])
  @@index([policyId])
  @@index([affiliateId])
  @@index([patientId])
  @@index([clientId])
  @@index([status])
  @@index([createdById])
  @@index([updatedById])
  @@index([submittedDate])
  @@index([settlementDate])
  @@index([createdAt])
}

model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String

  insurerId String
  insurer   Insurer @relation(fields: [insurerId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  status        InvoiceStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING_PAYMENT)
  billingPeriod String?

  totalAmount Float
  taxAmount   Float?

  expectedAffiliateCount Int?
  actualAffiliateCount   Int?
  countMatches           Boolean?

  expectedAmount Float?
  amountMatches  Boolean?

  discrepancyNotes String?

  issueDate   DateTime
  dueDate     DateTime?
  paymentDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  policies InvoicePolicy[]
  files    InvoiceFile[]

  @@index([invoiceNumber])
  @@index([insurerId])
  @@index([clientId])
  @@index([status])
  @@index([paymentStatus])
  @@index([issueDate])
  @@index([dueDate])
}

model InvoicePolicy {
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  policyId String
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  expectedAmount         Float
  expectedBreakdown      Json
  expectedAffiliateCount Int

  addedAt DateTime @default(now())

  @@id([invoiceId, policyId])
  @@index([invoiceId])
  @@index([policyId])
}

model Ticket {
  id             String @id @default(cuid())
  ticketSequence Int    @unique @default(autoincrement())
  ticketNumber   String @unique

  subject  String
  status   TicketStatus   @default(OPEN)
  priority TicketPriority @default(NORMAL)
  category String?

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  relatedClaimId String?
  relatedClaim   Claim?  @relation(fields: [relatedClaimId], references: [id])

  reporterId String?
  reporter   User?   @relation("TicketReporter", fields: [reporterId], references: [id])

  createdById String
  createdBy   User   @relation("TicketCreator", fields: [createdById], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("TicketAssignee", fields: [assignedToId], references: [id])

  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages TicketMessage[]

  @@index([ticketNumber])
  @@index([clientId])
  @@index([relatedClaimId])
  @@index([reporterId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([category])
}

model TicketMessage {
  id String @id @default(cuid())

  message String

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  files TicketFile[]

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
}

// ============================================================================
// FILE STORAGE (S3/Cloudflare R2 Compatible)
// ============================================================================

enum FileEntityType {
  CLAIM
  INVOICE
  TICKET
  DOCUMENT
}

// Central file record - represents one S3/R2 object
model File {
  id String @id @default(cuid())

  // Storage location (S3/R2)
  storageKey    String @unique // "claims/abc123/receipt.pdf"
  storageBucket String @default("default")

  // File metadata
  originalName String // Original filename for display
  fileSize     BigInt // Bytes (BigInt for >2GB files)
  mimeType     String // "application/pdf", "image/jpeg"
  checksum     String? // SHA256 for integrity verification

  // Workdrive metadata (denormalized for efficient browsing)
  entityType FileEntityType // Which module this belongs to
  entityId   String // ID of parent record (claimId, invoiceId, etc.)

  // Client scope (for multi-tenant browsing)
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  // Upload tracking
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  uploadedAt   DateTime @default(now())

  // Soft delete
  deletedAt DateTime?

  // Entity relations
  claimFile   ClaimFile?
  invoiceFile InvoiceFile?
  ticketFile  TicketFile?
  document    Document?

  // Workdrive indexes
  @@index([entityType, entityId]) // Browse by module + record
  @@index([entityType, clientId]) // Browse module filtered by client
  @@index([clientId, entityType]) // Browse client's files by module
  @@index([clientId, uploadedAt]) // Client's recent files

  // General indexes
  @@index([storageKey])
  @@index([uploadedById])
  @@index([uploadedAt])
  @@index([mimeType])
  @@index([deletedAt])
}

// ============================================================================
// ENTITY FILE LINKS
// ============================================================================

enum ClaimFileCategory {
  RECEIPT
  PRESCRIPTION
  LAB_REPORT
  DISCHARGE_SUMMARY
  AUTHORIZATION
  OTHER
}

// Claim files - multiple per claim
model ClaimFile {
  id String @id @default(cuid())

  fileId String @unique
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  // Claim-specific metadata
  category     ClaimFileCategory?
  description  String?
  displayOrder Int @default(0)

  createdAt DateTime @default(now())

  @@index([claimId])
  @@index([category])
}

// Claim invoices - tracks individual invoices/receipts for reimbursement
model ClaimInvoice {
  id String @id @default(cuid())

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  invoiceNumber   String
  providerName    String
  amountSubmitted Float

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([claimId])
  @@index([createdById])
}

// Claim reprocesses - tracks each reprocess cycle when insurer requests more info
model ClaimReprocess {
  id String @id @default(cuid())

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  reprocessDate        DateTime @db.Date
  reprocessDescription String
  businessDays         Int?

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([claimId])
  @@index([createdById])
}

enum InvoiceFileCategory {
  INVOICE_PDF
  BREAKDOWN
  RECEIPT
  SUPPORTING_DOC
  OTHER
}

// Invoice files - multiple per invoice
model InvoiceFile {
  id String @id @default(cuid())

  fileId String @unique
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Invoice-specific metadata
  category     InvoiceFileCategory?
  description  String?
  displayOrder Int @default(0)

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([category])
}

// Ticket message files - multiple per message
model TicketFile {
  id String @id @default(cuid())

  fileId String @unique
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  messageId String
  message   TicketMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  displayOrder Int @default(0)

  createdAt DateTime @default(now())

  @@index([messageId])
}

// ============================================================================
// DOCUMENT LIBRARY (standalone shared documents)
// ============================================================================

// Library documents - for sharing policies, guides, etc. with clients
model Document {
  id String @id @default(cuid())

  fileId String @unique
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  // Document metadata
  title       String
  description String?
  category    String?
  tags        String[] // For search/filtering

  // Visibility controls
  isPublic Boolean @default(false) // Visible to all clients
  isActive Boolean @default(true) // Soft disable

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Per-client access (when not public)
  clientAccess DocumentAccess[]

  @@index([category])
  @@index([isPublic])
  @@index([isActive])
}

model DocumentAccess {
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  grantedById String?
  grantedBy   User?   @relation(fields: [grantedById], references: [id])

  createdAt DateTime @default(now())

  @@id([documentId, clientId])
  @@index([documentId])
  @@index([clientId])
}

// ============================================================================
// OPTIONAL TABLES
// ============================================================================

model AuditLog {
  id String @id @default(cuid())

  action       String
  resourceType String
  resourceId   String

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  changes   Json?
  metadata  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([clientId])
  @@index([createdAt])
}

model Notification {
  id String @id @default(cuid())

  title   String
  message String
  type    NotificationType @default(INFO)

  templateId String?

  resourceType String?
  resourceId   String?
  actionUrl    String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
  @@index([templateId])
  @@index([resourceType, resourceId])
}

model Invitation {
  id    String @id @default(cuid())
  email String
  token String @unique

  type   InvitationType
  status InvitationStatus @default(PENDING)

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  entityData Json? // For EMPLOYEE/AGENT: {firstName, lastName, position, etc.}

  affiliateId String?    @unique
  affiliate   Affiliate? @relation(fields: [affiliateId], references: [id])

  expiresAt  DateTime
  acceptedAt DateTime?

  createdById String
  createdBy   User   @relation("InvitationCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([status])
  @@index([type])
  @@index([createdById])
}

// ============================================================================
// ENUMS
// ============================================================================

enum PolicyStatus {
  ACTIVE
  PENDING
  EXPIRED
  CANCELLED
}

enum AffiliateType {
  OWNER
  DEPENDENT
}

enum CoverageType {
  T
  TPLUS1
  TPLUSF
}

enum ClaimStatus {
  DRAFT
  PENDING_INFO
  VALIDATION
  SUBMITTED
  RETURNED
  SETTLED
  CANCELLED
}

enum CareType {
  AMBULATORY
  HOSPITALIZATION
  MATERNITY
  EMERGENCY
  OTHER
}

enum InvoiceStatus {
  PENDING
  VALIDATED
  DISCREPANCY
  CANCELLED
}

enum PaymentStatus {
  PENDING_PAYMENT
  PAID
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CLIENT
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum InvitationType {
  EMPLOYEE
  AGENT
  AFFILIATE
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}
